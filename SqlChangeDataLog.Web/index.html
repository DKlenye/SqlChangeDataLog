<!DOCTYPE html>
<html>
<head>
    <title>ChangeLog</title>
    <link rel="stylesheet" type="text/css" href="Content/webix.css"/>
    <link rel="stylesheet" type="text/css" href="Content/sidebar.css"/>

    <script type="text/javascript" src="Scripts/polyfill.js"></script>
    <script type="text/javascript" src="Scripts/webix.js"></script>
    <script type="text/javascript" src="Scripts/Sidebar.js"></script>
    
    <style type="text/css">
        
        .webix_layout_toolbar.webix_toolbar .bt_1 .webixtype_base{
            background: #50E650;
            background: #FF7777;
        }
        
        .webix_layout_toolbar.webix_toolbar .connect .webixtype_base {
            background: #27ae60
        }
        
        .webix_icon {
                font-size: 20px;
        }
        
       
    </style>

    <script type="text/javascript">

        

        webix.protoUI({
            name: 'database-toolbar',
            defaults: {
                id: 'tbar',
                height: 66,
                cols: [
                    {id:'addbutton', view: 'icon', icon: 'plus-circle', tooltip:'Add database', click: '$$("tbar")._addButtonClick()' },
                    {id:'addtext', width:250, hidden:true,
                        rows: [
                            {
                                id: 'servertext',
                                label: 'server',
                                view: 'text',
                                height: 30,
                                on: {
                                    'onKeyPress': function(key,event) {
                                        switch(key) {
                                            //ESC
                                            case 27:
                                            {
                                                $$('tbar')._cancelConfirm();
                                                return false;
                                            }
                                            //ENTER
                                            case 13:
                                            {
                                                $$('databasetext').focus();
                                                $$('databasetext').getInputNode().select();
                                                return false;
                                            }
                                        }
                                    }
                                }
                            },
                            {
                                id: 'databasetext',
                                label: 'database',
                                view: 'text',
                                height: 30,
                                on: {
                                    'onKeyPress': function (key, event) {
                                        switch (key) {
                                            //ESC 
                                            case 27:
                                                {
                                                    $$('tbar')._cancelConfirm();
                                                    return false;
                                                }
                                                //ENTER
                                            case 13:
                                            {
                                                $$('logtabletext').focus();
                                                $$('logtabletext').getInputNode().select();
                                                    return false;
                                                }
                                        }
                                    }
                                }
                            },
                            {
                                id: 'logtabletext',
                                label: 'log_table',
                                view: 'text',
                                height: 30,
                                value:'ChangeLog',
                                on: {
                                    'onKeyPress': function (key, event) {
                                        switch (key) {
                                            //ESC  
                                            case 27:
                                                {
                                                    $$('tbar')._cancelConfirm();
                                                    return false;
                                                }
                                                //ENTER
                                            case 13:
                                                {
                                                    $$('tbar')._confirmDatabase();
                                                    return false;
                                                }
                                        }
                                    }
                                }
                            }
                        ]
                    },
                    { id:'addconfirm', width:100,hidden:true,
                        rows: [
                            {},
                            { view: 'button', type: 'icon', height: 30, label: 'Cancel', icon: 'ban', click: '$$("tbar")._cancelConfirm()' },
                            { view: 'button', type: 'icon', height: 30, label: 'Ok', icon: 'check', click: '$$("tbar")._confirmDatabase()' }
                        ]
                    }
                ]
            },


            _confirmDatabase:function() {

                var textData = {};

                $$('addtext').getChildViews().forEach(function(textInput) {
                    textData[textInput.config.label] = textInput.getValue();
                });

                this._cancelConfirm();

                $$('tbar')._addButton(textData);

            },

            _cancelConfirm:function() {
                $$("addbutton").show();
                $$("addtext").hide();
                $$("addconfirm").hide();

                this.define('height', 66);
                this.resize();

            },

            _addButtonClick:function() {
                $$("addbutton").hide();
                $$("addtext").show();
                $$("addconfirm").show();
                this.define('height', 99);
                this.resize();


                $$('servertext').focus();
                $$('servertext').getInputNode().select();
            },

            _addButton: function (cfg) {
                var insertIndex = this.index($$("addbutton"));
                var view = this.addView(this._createButton(cfg), insertIndex);

                this.save_state();

                this._connect($$(view));
            },

            _createButton: function (cfg) {
                var template = webix.template('<span class="webix_icon fa-icon fa-database"></span> #server# #database# <br/>#log_table#');
                return {
                    icon: 'database',
                    autowidth: true,
                    view: "button",
                    type: "htmlbutton",
                    icon: "database",
                    server: cfg.server,
                    database: cfg.database,
                    log_table: cfg.log_table,
                    label: template(cfg),
                    on: {
                        'onItemClick': this.onButtonClick
                    }
                    
                };
            },

            _connect:function(button) {

                if (this.connection) {
                    webix.html.removeCss(this.connection.getNode(), "connect");
                }

                this.connection = button;
                webix.html.addCss(button.getNode(), "connect");
                LoadTables(button.config.server, button.config.database);
            },
            
            onButtonClick:function(id) {
                var button = $$(id);
                $$("tbar")._connect(button);
            },

            restore_state:function() {
                var state = this.load_state();
                var me = this;
                if (state) {
                    state.forEach(function(cfg) {
                        var insertIndex = me.index($$("addbutton"));
                        view = me.addView(me._createButton(cfg), insertIndex);
                    });
                }
            },

            get_State: function () {
                var state = [];
                this.getChildViews().forEach(function (v) {
                    if (v.name == "button") {
                        state.push({
                            server: v.config.server,
                            database: v.config.database,
                            log_table: v.config.log_table
                        });
                    }
                });
                return JSON.stringify(state);
            },

            save_state:function (){
                webix.storage.local.put("tbarState", this.get_State());
            },

            load_state:function() {
                var state = webix.storage.local.get("tbarState");
                if(state) return JSON.parse(state);
            }
            

        },webix.ui.toolbar);

        webix.ready(function () {

            var icons = {
                'insert': 'fa-plus-square-o ',
                'update': 'fa-edit',
                'delete': 'fa-minus-square-o'
            };

            webix.ui({
                id: "app.layout",
                rows: [
                    {
                        view: "database-toolbar",
                        id: 'tbar'
                    },
                    {
                        cols: [
                            {
                                id: "app.sidebar",
                                view: "sidebar",
                                collapsed: true,
                                data: [
                                    {
                                        id: "datalogsettings",
                                        icon: "table",
                                        value: "Data log settings"
                                    },
                                    {
                                        id: "viewlog",
                                        icon: "search",
                                        value: "View log data"
                                    }
                                ],
                                on: {
                                    onItemClick: function (id) {
                                        $$(id).show(false, false);
                                    }
                                }
                            },
                            {
                                id: "viewscroll",
                                cells: [
                                    {
                                        id: "datalogsettings",
                                        cols: [
                                            {
                                                view: 'datatable',
                                                id: 'tables',
                                                gravity: 1,
                                                select: "row",
                                                on: {
                                                    onSelectChange: function () {
                                                        var selection = this.getSelectedItem();

                                                        if (!selection) {
                                                            var grid = $$('columnstable');
                                                            grid.clearAll();
                                                            return;
                                                        }

                                                        webix.ajax().post('/Handlers/SelectTableDetails.ashx', { server: '.', database: 'DDD', tableName: selection.Name }, function (data) {

                                                            var a = []
                                                            data = JSON.parse(data);
                                                            console.log(data);

                                                            data.Columns.forEach(function (col) {
                                                                a.push({ ColumnName: col });
                                                            });

                                                            var grid = $$('columnstable');
                                                            grid.clearAll();
                                                            grid.parse(a);

                                                        });
                                                    }
                                                },
                                                columns: [
                                                    {
                                                        id: 'Operations',
                                                        header: [
                                                            "Operations",
                                                            {
                                                                content: "selectFilter",
                                                                options: [{ id: "All", value: "All" }, { id: "Logging", value: "Logging" }, { id: "Not Logging", value: "Not Logging"}],
                                                                compare: function (value, filter) {
                                                                    if (filter == "All") return true;
                                                                    return filter == "Logging" ? !!value : !value;
                                                                }
                                                            }
                                                        ],
                                                        width: 130,
                                                        template: function (obj) {

                                                            if (!obj.Operations) return "";

                                                            var buttonTpl = webix.template("<span class='webix_icon #icon#' style='cursor:pointer'></span>");
                                                            var operations = obj.Operations;

                                                            return operations.map(function (o) {
                                                                return buttonTpl({ icon: icons[o] || 'fa-question' });
                                                            }).join("");

                                                        }
                                                    },
                                                    { id: "Name", fillspace: true, header: ["Table", { content: "textFilter"}], sort: "string" }
                                                ]
                                            },
                                            { view: 'resizer' },
                                            {
                                                id: "tabledetails",
                                                rows: [
                                                    {
                                                        view: 'toolbar',
                                                        cols: [
                                                            {
                                                                view: "segmented",
                                                                optionWidth: 120,
                                                                value: 4,
                                                                options: [
                                                                    { id: "1", value: "</span><span class='webix_icon " + icons["insert"] + "'></span><span style='padding-left: 4px'>Insert</span>" },
                                                                    { id: "2", value: "<span class='webix_icon " + icons['update'] + "'></span><span style='padding-left: 4px'>Update</span>" },
                                                                    { id: "3", value: "<span class='webix_icon " + icons['delete'] + "'></span><span style='padding-left: 4px'>Delete</span>" }
                                                                ]
                                                            }
                                                        ]
                                                    },
                                                    {
                                                        rows: [
                                                            {
                                                                view: 'segmented',
                                                                multiview: true,
                                                                value: 'triggertable',
                                                                options: [
                                                                    { value: "<span class='webix_icon fa-columns'></span><span style='padding-left: 4px'>Columns</span>", id: 'triggertable' },
                                                                    { value: "<span class='webix_icon fa-file-text-o'></span><span style='padding-left: 4px'>TriggerText</span>", id: 'triggertext' }
                                                                ]
                                                            },
                                                            {
                                                                cells: [
                                                                    {
                                                                        id: 'triggertable',
                                                                        rows: [{
                                                                            view: 'datatable',
                                                                            id: 'columnstable',
                                                                            columns: [
                                                                                    { id: "checked", header: { content: "masterCheckbox" }, template: "{common.checkbox()}", width: 40 },
                                                                                    { id: "ColumnName", fillspace: true, header: "Column Name" }
                                                                                ],
                                                                            data: [
                                                                                    { checked: true, ColumnName: 'VehicleId' },
                                                                                    { checked: false, ColumnName: 'RegistrationNumber' }
                                                                                ]
                                                                        },
                                                                            {
                                                                                height: 45,
                                                                                cols: [
                                                                                    { view: "button", type: "iconButton", label: "Save", icon: "floppy-o", width: 95 },
                                                                                    {}
                                                                                ]
                                                                            }
                                                                        ]
                                                                    },
                                                                    {
                                                                        id: "triggertext",
                                                                        rows: [
                                                                            {
                                                                                view: 'textarea'
                                                                            },
                                                                            {
                                                                                height: 45,
                                                                                cols: [
                                                                                { view: "button", type: "iconButton", label: "Save", icon: "floppy-o", width: 95 },
                                                                                {}
                                                                        ]
                                                                            }
                                                                        ]
                                                                    }
                                                                ]
                                                            }
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        id: "viewlog",
                                        cols: [
                                            {   
                                                gravity:1.5,
                                                rows: [
                                                    {
                                                        view: 'datatable',
                                                        columns: [
                                                            { id: "Id", header: "Id", width: 100 },
                                                            { id: "Date", header: "Date", width: 100 },
                                                            { id: "UserName", header: "UserName", width: 100 },
                                                            { id: "ChangeType", header: "ChangeType", width: 100 },
                                                            { id: "TableName", header: "TableName",fillspace: true },
                                                            { id: "IdString", header: "IdString",width:100 }
                                                        ],
                                                        select:'row',
                                                        data:[
                                                            {}, {}, {}, {}
                                                        ],
                                                        pager:'pagerA'
                                                    },
                                                    {
                                                        paddingY: 7,
                                                        rows: [
							                                {
							                                    view: "pager", id: "pagerA",
							                                    template: "{common.first()} {common.prev()} {common.pages()} {common.next()} {common.last()} Page {common.page()} from #limit#",
                                                                size: 50,
							                                    group: 5
							                                }
						                                ]
							                        }
                                                ]
                                            },
                                            { view: "resizer" },
                                            {
                                                view: 'datatable',
                                                columns: [
                                                    { id: "Column", header: "Column", fillspace: true },
                                                    { id: "OldValue", header: "Date" },
                                                    { id: "NewValue", header: "Date" }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ]
            });

            $$('tbar').restore_state();
            $$('app.sidebar').select('datalogsettings');

        });


        var LoadTables = function(server, database) {

            var grid = $$("tables");
            grid.disable();
            grid.clearAll();
            grid.showOverlay("Loading <span class='webix_icon fa-spinner fa-spin'></span>");

            webix.ajax().post('/Handlers/SelectTables.ashx', { server: server, database: database }, function(data) {
                grid.parse(data);
                grid.filterByAll();
                grid.hideOverlay();
                grid.enable();
            });
        };



        


    </script>

</head>
<body>

</body>
</html>
